---
title: Настройка общей учетной записи git для нескольких пользователей
date: '2022-03-02'
tags: ['git', 'linux', 'devops', 'github']
draft: false
authors: ['mastergowen']
---

## Задача

Есть сервер под Ubuntu с доступом для нескольких разработчиков. Нужно создать общую рабочую папку и настроить git так, чтобы он не требовал ввода учетных данных при работе с `github.com`.

Использование ssh невозможно из-за особенностей настройки фаервола (22 порт закрыт на вход и выход).

## Решение

Пользователи будут авторизоваться под общей учетной записью с ограниченными правами (задаются контекстом репозитория/организации). Для аутентификации используется сгенерированный токен.
Можно настроить права учетной записи и права (и время действия) для токена.

1. Создаем учетную запись на `github.com`.
2. Создаем и настраиваем токен для учетной записи.
3. На сервере создаем общую рабочую папку `/app` с доступом для группы `dev`. Добавляем пользователей в группу.

```shell
sudo mkdir /app
sudo groupadd dev
sudo chgrp dev /app
sudo chmod -R g+rws /app
sudo usermod -aG dev USERNAME  # Для каждого пользователя
```

4. На сервере настраиваем `git` глобально:

```
sudo git config --global -e
```

Содержимое файла конфигурации:

```gitconfig
[credential]
        helper = store --file /app/git.store
[user]
        name = GITHUB_USERNAME
        email = GITHUB_EMAIL
[core]
        sharedRepository = group
```

5. Создаем файл с учетными данными

```shell
cat << EOF > /app/git.store
https://GITHUB_USERNAME:GITHUB_TOKEN@github.com
EOF

sudo chmod g+rw /app/git.store
```

6. Создаем пользовательские файлы конфигурации git

Поскольку **глобальный конфиг не завелся в юзерспейсе**, а разбираться с этим сейчас не лучший вариант, то создаем в домашней папке каждого юзера жесткие ссылки к глобальному файлу конфигурации git.

> _Флаг **-f** перезапишет существующие файлы /home/USERNAME/.gitconfig если они существуют._

```shell
sudo su
for d in /home/*;do ln -f /root/.gitconfig "$d/.gitconfig";done
exit

```

---

## Возможные проблемы и устранение

### Не применяется конфиг, ничего не работает

Попробовать перелогиниться. Это точно надо сделать.

### Не применяется (полностью либо частично) конфиг, требует учетные данные

Возможно что-то переписывает переменные в конфигурации. Нужно посмотреть `git config --list --show-origin` и удалить ненужное.

### Нет доступа на запись к склонированному репозиторию

Нужно дать права для группы `dev`

```shell
sudo chmod -R g+rw /app/REPO_PATH
```
